# load data ---------------------------------------------------------------

# data from https://covid.cdc.gov/covid-data-tracker/#vaccinations
# Toggle: View by People, Metric % population

library(tidyverse)

vax <- read_csv(here::here("data/covid19_vaccinations_in_the_united_states.csv"), skip = 2)

vax <- vax %>%
  rename(State = `State/Territory/Federal Entity`) %>%
  select(State, 
         `People with at least One Dose by State of Residence`,
         `Percent of Total Pop with at least One Dose by State of Residence`) %>%
  mutate(State = recode(State, "New York State" = "New York"))

# from https://en.wikipedia.org/wiki/2020_United_States_presidential_election
# pasted with help from `datapasta`
votes <- tibble::tribble(
  ~State, ~votes_biden, ~pct_biden, ~ev_biden, ~votes_trump, ~pct_trump, ~ev_trump, ~votes_libert, ~pct_libert, ~ev_libert, ~votes_green, ~pct_green, ~ev_green, ~votes_other, ~pct_other, ~ev_other, ~votes_margin, ~pct_margin, ~swing_margin, ~votes_total,
      "Ala.",     849624,  "36.57%",   "–",      1441170,  "62.03%",   "9",     25176,  "1.08%",  "–",     "[l]",      "[l]",  "–",    "7,312",    "0.31%",  "–",  "−591,546",  "−25.46%",  "2.27%",      2323282,
    "Alaska",     153778,  "42.77%",   "–",       189951,  "52.83%",   "3",      8897,  "2.47%",  "–",     "[m]",      "[m]",  "–",    "6,904",    "1.92%",  "–",   "−36,173",  "−10.06%",  "4.67%",       359530,
   "Arizona",    1672143,  "49.36%",  "11",      1661686,  "49.06%",   "–",     51465,  "1.52%",  "–",   "1,557",    "0.05%",  "–",      "475",    "0.01%",  "–",    "10,457",    "0.31%",  "3.81%",      3387326,
      "Ark.",     423932,  "34.78%",   "–",       760647,  "62.40%",   "6",     13133,  "1.08%",  "–",   "2,980",    "0.24%",  "–",   "18,377",    "1.51%",  "–",  "−336,715",  "−27.62%", "−0.70%",      1219069,
    "Calif.",   11110250,  "63.48%",  "55",      6006429,  "34.32%",   "–",    187895,  "1.07%",  "–",  "81,029",    "0.46%",  "–",  "115,278",    "0.66%",  "–", "5,103,821",   "29.16%", "−0.95%",     17500881,
     "Colo.",    1804352,  "55.40%",   "9",      1364607,  "41.90%",   "–",     52460,  "1.61%",  "–",   "8,986",    "0.28%",  "–",   "26,575",    "0.82%",  "–",   "439,745",   "13.50%",  "8.59%",      3256980,
     "Conn.",    1080831,  "59.26%",   "7",       714717,  "39.19%",   "–",     20230,  "1.11%",  "–",   "7,538",    "0.41%",  "–",      "541",    "0.03%",  "–",   "366,114",   "20.07%",  "6.43%",      1823857,
      "Del.",     296268,  "58.74%",   "3",       200603,  "39.77%",   "–",      5000,  "0.99%",  "–",   "2,139",    "0.42%",  "–",      "336",    "0.07%",  "–",    "95,665",   "18.97%",  "7.60%",       504346,
      "D.C.",     317323,  "92.15%",   "3",        18586,   "5.40%",   "–",      2036,  "0.59%",  "–",   "1,726",    "0.50%",  "–",    "4,685",    "1.36%",  "–",   "298,737",   "86.75%", "−0.03%",       344356,
   "Florida",    5297045,  "47.86%",   "–",      5668731,  "51.22%",  "29",     70324,  "0.64%",  "–",  "14,721",    "0.13%",  "–",   "16,635",    "0.15%",  "–",  "−371,686",   "−3.36%", "−2.16%",     11067456,
   "Georgia",    2473633,  "49.47%",  "16",      2461854,  "49.24%",   "–",     62229,  "1.24%",  "–",   "1,013",    "0.02%",  "–",    "1,231",    "0.02%",  "–",    "11,779",    "0.24%",  "5.37%",      4999960,
    "Hawaii",     366130,  "63.73%",   "4",       196864,  "34.27%",   "–",      5539,  "0.96%",  "–",   "3,822",    "0.67%",  "–",    "2,114",    "0.37%",  "–",   "169,266",   "29.46%", "−2.72%",       574469,
     "Idaho",     287021,  "33.07%",   "–",       554119,  "63.84%",   "4",     16404,  "1.89%",  "–",     "407",    "0.05%",  "–",   "10,063",    "1.16%",  "–",  "−267,098",  "−30.77%",  "1.00%",       868014,
  "Illinois",    3471915,  "57.54%",  "20",      2446891,  "40.55%",   "–",     66544,  "1.10%",  "–",  "30,494",    "0.51%",  "–",   "17,900",    "0.30%",  "–", "1,025,024",   "16.99%", "−0.08%",      6033744,
   "Indiana",    1242416,  "40.96%",   "–",      1729519,  "57.02%",  "11",     59232,  "1.95%",  "–",     "989",    "0.03%",  "–",      "965",    "0.03%",  "–",  "−487,103",  "−16.06%",  "3.11%",      3033121,
      "Iowa",     759061,  "44.89%",   "–",       897672,  "53.09%",   "6",     19637,  "1.16%",  "–",   "3,075",    "0.18%",  "–",   "11,426",    "0.68%",  "–",  "−138,611",   "−8.20%",  "1.21%",      1690871,
    "Kansas",     570323,  "41.56%",   "–",       771406,  "56.21%",   "6",     30574,  "2.23%",  "–",  "669[n]", "0.05%[n]",  "–", "1,014[n]", "0.07%[n]",  "–",  "−201,083",  "−14.65%",  "5.95%",      1372303,
       "Ky.",     772474,  "36.15%",   "–",      1326646,  "62.09%",   "8",     26234,  "1.23%",  "–",     "716",    "0.03%",  "–",   "10,698",    "0.50%",  "–",  "−554,172",  "−25.94%",  "3.90%",      2136768,
       "La.",     856034,  "39.85%",   "–",      1255776,  "58.46%",   "8",     21645,  "1.01%",  "–",       "–",        "–",  "–",   "14,607",    "0.68%",  "–",  "−399,742",  "−18.61%",  "1.03%",      2148062,
   "Maine †",     435072,  "53.09%",   "2",       360737,  "44.02%",   "–",     14152,  "1.73%",  "–",   "8,230",    "1.00%",  "–",    "1,270",    "0.15%",  "–",    "74,335",    "9.07%",  "6.11%",       819461,
      "ME-1",     266376,  "60.11%",   "1",       164045,  "37.02%",   "–",      7343,  "1.66%",  "–",   "4,654",    "1.05%",  "–",      "694",    "0.16%",  "–",   "102,331",   "23.09%",  "8.28%",       443112,
      "ME-2",     168696,  "44.82%",   "–",       196692,  "52.26%",   "1",      6809,  "1.81%",  "–",   "3,576",    "0.95%",  "–",      "576",    "0.15%",  "–",   "−27,996",   "−7.44%",  "2.85%",       376349,
       "Md.",    1985023,  "65.36%",  "10",       976414,  "32.15%",   "–",     33488,  "1.10%",  "–",  "15,799",    "0.52%",  "–",   "26,306",    "0.87%",  "–", "1,008,609",   "33.21%",  "6.79%",      3037030,
     "Mass.",    2382202,  "65.60%",  "11",      1167202,  "32.14%",   "–",     47013,  "1.29%",  "–",  "18,658",    "0.51%",  "–",   "16,327",    "0.45%",  "–", "1,215,000",   "33.46%",  "6.26%",      3631402,
     "Mich.",    2804040,  "50.62%",  "16",      2649852,  "47.84%",   "–",     60381,  "1.09%",  "–",  "13,718",    "0.25%",  "–",   "11,311",    "0.20%",  "–",   "154,188",    "2.78%",  "3.01%",      5539302,
     "Minn.",    1717077,  "52.40%",  "10",      1484065,  "45.28%",   "–",     34976,  "1.07%",  "–",  "10,033",    "0.31%",  "–",   "31,020",    "0.95%",  "–",   "233,012",    "7.11%",  "5.59%",      3277171,
     "Miss.",     539398,  "41.06%",   "–",       756764,  "57.60%",   "6",      8026,  "0.61%",  "–",   "1,498",    "0.11%",  "–",    "8,073",    "0.61%",  "–",  "−217,366",  "−16.55%",  "1.28%",      1313759,
       "Mo.",    1253014,  "41.41%",   "–",      1718736,  "56.80%",  "10",     41205,  "1.36%",  "–",   "8,283",    "0.27%",  "–",    "4,724",    "0.16%",  "–",  "−465,722",  "−15.39%",  "3.25%",      3025962,
     "Mont.",     244786,  "40.55%",   "–",       343602,  "56.92%",   "3",     15252,  "2.53%",  "–",       "–",        "–",  "–",       "34",    "0.01%",  "–",   "−98,816",  "−16.37%",  "4.05%",       603674,
    "Neb. †",     374583,  "39.17%",   "–",       556846,  "58.22%",   "2",     20283,  "2.12%",  "–",     "[l]",      "[l]",  "–",    "4,671",    "0.49%",  "–",  "−182,263",  "−19.06%",  "5.99%",       956383,
      "NE-1",     132261,  "41.09%",   "–",       180290,  "56.01%",   "1",      7495,  "2.33%",  "–",     "[l]",      "[l]",  "–",    "1,840",    "0.57%",  "–",   "−48,029",  "−14.92%",  "5.80%",       321886,
      "NE-2",     176468,  "51.95%",   "1",       154377,  "45.45%",   "–",      6909,  "2.03%",  "–",     "[l]",      "[l]",  "–",    "1,912",    "0.56%",  "–",    "22,091",    "6.50%",  "8.74%",       339666,
      "NE-3",      65854,  "22.34%",   "–",       222179,  "75.36%",   "1",      5879,  "1.99%",  "–",     "[l]",      "[l]",  "–",      "919",    "0.31%",  "–",  "−156,325",  "−53.02%",  "1.17%",       294831,
   "Nev.[o]",     703486,  "50.06%",   "6",       669890,  "47.67%",   "–",     14783,  "1.05%",  "–",       "–",        "–",  "–",   "17,217",    "1.23%",  "–",    "33,596",    "2.39%", "−0.03%",      1405376,
      "N.H.",     424937,  "52.71%",   "4",       365660,  "45.36%",   "–",     13236,  "1.64%",  "–",     "217",    "0.03%",  "–",    "2,155",    "0.27%",  "–",    "59,277",    "7.35%",  "6.98%",       806205,
   "N.J.[p]",    2608335,  "57.33%",  "14",      1883274,  "41.40%",   "–",     31677,  "0.70%",  "–",  "14,202",    "0.31%",  "–",   "11,865",    "0.26%",  "–",   "725,061",   "15.94%",  "1.84%",      4549353,
      "N.M.",     501614,  "54.29%",   "5",       401894,  "43.50%",   "–",     12585,  "1.36%",  "–",   "4,426",    "0.48%",  "–",    "3,446",    "0.37%",  "–",    "99,720",   "10.79%",  "2.58%",       923965,
   "N.Y.[q]",    5230985,  "60.86%",  "29",      3244798,  "37.75%",   "–",     60234,  "0.70%",  "–",  "32,753",    "0.38%",  "–",   "26,056",    "0.30%",  "–", "1,986,187",   "23.11%",  "0.62%",      8594826,
      "N.C.",    2684292,  "48.59%",   "–",      2758775,  "49.93%",  "15",     48678,  "0.88%",  "–",  "12,195",    "0.22%",  "–",   "20,864",    "0.38%",  "–",   "−74,483",   "−1.35%",  "2.31%",      5524804,
      "N.D.",     114902,  "31.76%",   "–",       235595,  "65.11%",   "3",      9393,  "2.60%",  "–",     "[l]",      "[l]",  "–",    "1,929",    "0.53%",  "–",  "−120,693",  "−33.36%",  "2.37%",       361819,
      "Ohio",    2679165,  "45.24%",   "–",      3154834,  "53.27%",  "18",     67569,  "1.14%",  "–",  "18,812",    "0.32%",  "–",    "1,822",    "0.03%",  "–",  "−475,669",   "−8.03%",  "0.10%",      5922202,
     "Okla.",     503890,  "32.29%",   "–",      1020280,  "65.37%",   "7",     24731,  "1.58%",  "–",       "–",        "–",  "–",   "11,798",    "0.76%",  "–",  "−516,390",  "−33.09%",  "3.99%",      1560699,
    "Oregon",    1340383,  "56.45%",   "7",       958448,  "40.37%",   "–",     41582,  "1.75%",  "–",  "11,831",    "0.50%",  "–",   "22,077",    "0.93%",  "–",   "381,935",   "16.08%",  "5.10%",      2374321,
       "Pa.",    3458229,  "50.01%",  "20",      3377674,  "48.84%",   "–",     79380,  "1.15%",  "–",     "[r]",      "[r]",  "–",      "[r]",      "[r]",  "–",    "80,555",    "1.16%",  "1.88%",      6915283,
      "R.I.",     307486,  "59.39%",   "4",       199922,  "38.61%",   "–",      5053,  "0.98%",  "–",     "[l]",      "[l]",  "–",    "5,296",    "1.02%",  "–",   "107,564",   "20.77%",  "5.26%",       517757,
      "S.C.",    1091541,  "43.43%",   "–",      1385103,  "55.11%",   "9",     27916,  "1.11%",  "–",   "6,907",    "0.27%",  "–",    "1,862",    "0.07%",  "–",  "−293,562",  "−11.68%",  "2.59%",      2513329,
      "S.D.",     150471,  "35.61%",   "–",       261043,  "61.77%",   "3",     11095,  "2.63%",  "–",       "–",        "–",  "–",        "–",        "–",  "–",  "−110,572",  "−26.16%",  "3.63%",       422609,
     "Tenn.",    1143711,  "37.45%",   "–",      1852475,  "60.66%",  "11",     29877,  "0.98%",  "–",   "4,545",    "0.15%",  "–",   "23,243",    "0.76%",  "–",  "−708,764",  "−23.21%",  "2.80%",      3053851,
  "Texas[s]",    5259126,  "46.48%",   "–",      5890347,  "52.06%",  "38",    126243,  "1.12%",  "–",  "33,396",    "0.30%",  "–",    "5,944",    "0.05%",  "–",  "−631,221",   "−5.58%",  "3.41%",     11315056,
      "Utah",     560282,  "37.65%",   "–",       865140,  "58.13%",   "6",     38447,  "2.58%",  "–",   "5,053",    "0.34%",  "–",   "19,367",    "1.30%",  "–",  "−304,858",  "−20.48%", "−2.40%",      1488289,
       "Vt.",     242820,  "66.09%",   "3",       112704,  "30.67%",   "–",      3608,  "0.98%",  "–",   "1,310",    "0.36%",  "–",    "6,986",    "1.90%",  "–",   "130,116",   "35.41%",  "9.00%",       367428,
       "Va.",    2413568,  "54.11%",  "13",      1962430,  "44.00%",   "–",     64761,  "1.45%",  "–",     "[l]",      "[l]",  "–",   "19,765",    "0.44%",  "–",   "451,138",   "10.11%",  "4.79%",      4460524,
     "Wash.",    2369612,  "57.97%",  "12",      1584651,  "38.77%",   "–",     80500,  "1.97%",  "–",  "18,289",    "0.45%",  "–",   "34,579",    "0.85%",  "–",   "784,961",   "19.20%",  "3.49%",      4087631,
     "W.Va.",     235984,  "29.69%",   "–",       545382,  "68.62%",   "5",     10687,  "1.34%",  "–",   "2,599",    "0.33%",  "–",       "79",    "0.01%",  "–",  "−309,398",  "−38.93%",  "3.14%",       794731,
      "Wis.",    1630866,  "49.45%",  "10",      1610184,  "48.82%",   "–",     38491,  "1.17%",  "–",   "1,089",    "0.03%",  "–",   "17,411",    "0.53%",  "–",    "20,682",    "0.63%",  "1.40%",      3298041,
      "Wyo.",      73491,  "26.55%",   "–",       193559,  "69.94%",   "3",      5768,  "2.08%",  "–",     "[l]",      "[l]",  "–",    "3,947",    "1.43%",  "–",  "−120,068",  "−43.38%",  "2.92%",       276765,
     "Total",   81268924,  "51.31%", "306",     74216154,  "46.86%", "232",   1865724,  "1.18%",  "–", "405,035",    "0.26%",  "–",  "627,566",    "0.40%",  "–", "7,052,770",    "4.45%",  "2.35%",    158383403
  )

# recode states and join
vax_and_votes <- votes %>%
  mutate(State = recode(State,
                        "Ala." = "Alabama",
                        "Ark." = "Arkansas",
                        "Calif." = "California",
                        "Colo." = "Colorado",
                        "Conn." = "Connecticut",
                        "Del." = "Delaware",
                        "D.C." = "District of Columbia",
                        "Ky." = "Kentucky",
                        "La." = "Louisiana",
                        "Maine †" = "Maine",
                        "Md." = "Maryland",
                        "Mass." = "Massachusetts",
                        "Mich." = "Michigan",
                        "Minn." = "Minnesota",
                        "Miss." = "Mississippi", 
                        "Mo." = "Missouri",
                        "Mont." = "Montana",
                        "Neb. †" = "Nebraska",
                        "Nev.[o]" = "Nevada",
                        "N.H." = "New Hampshire",
                        "N.J.[p]" = "New Jersey",
                        "N.M." = "New Mexico",
                        "N.Y.[q]" = "New York",
                        "N.C." = "North Carolina",
                        "N.D." = "North Dakota",
                        "Okla." = "Oklahoma",
                        "Pa." = "Pennsylvania",
                        "R.I." = "Rhode Island",
                        "S.C." = "South Carolina",
                        "S.D." = "South Dakota",
                        "Tenn." = "Tennessee",
                        "Texas[s]" = "Texas",
                        "Vt." = "Vermont",
                        "Va." = "Virginia",
                        "Wash." = "Washington",
                        "W.Va." = "West Virginia",
                        "Wis." = "Wisconsin",
                        "Wyo." = "Wyoming")) %>%
  select(State, pct_biden, pct_trump) %>%
  inner_join(vax, by = "State") %>%
  rename(pct_one_shot = `Percent of Total Pop with at least One Dose by State of Residence`) %>%
  mutate(
    pct_biden = parse_number(pct_biden),
    pct_trump = parse_number(pct_trump),
    pct_one_shot = parse_number(pct_one_shot)
  ) %>% 
  filter(State != "District of Columbia")

# NYT style plot ----------------------------------------------------------

library(ggtext)
library(ggrepel)

theme_set(
  firasans::theme_ipsum_fsc(
    axis_text_family = "Fira Sans Condensed",
    axis_text_size = 10, 
    axis_title_size = 14,
    axis_title_just = "cc") +
    theme(panel.grid.minor = element_blank(), 
          plot.title = element_markdown(face = "plain"),
          plot.subtitle = element_markdown(),
          plot.caption = element_markdown(),
          plot.title.position = "plot"
    )
)

party_colors <- c(Blue = "#2E74C0", Red = "#CB454A", Swing = "gray")

vax_and_votes %>% # first grab state abbreviations and assign party affiliation
  left_join(tibble(State = state.name, state_abb = state.abb), by = "State") %>%
  mutate(
    party = case_when(
      pct_trump > 52 ~ "Red",
      pct_biden > 52 ~ "Blue",
      TRUE ~ "Swing"
    ), 
    party_strength = case_when(
      party == "Red" ~ pct_trump/100 + .35,
      party == "Blue" ~ pct_biden/100 + .35,
      party == "Swing" ~ .9
    )
  ) %>%
  ggplot() + 
  aes(x = pct_trump/100, y = pct_one_shot/100) + 
  geom_segment(aes(x = .3, xend = .7, y = .7, yend = .7), size = .3, color = "#F0F0F0") + 
  geom_segment(aes(x = .3, xend = .7, y = .3, yend = .3), size = .3, color = "#F0F0F0") + 
  geom_segment(aes(x = .3, xend = .3, y = .3, yend = .7), size = .3, color = "#F0F0F0") + 
  geom_segment(aes(x = .7, xend = .7, y = .3, yend = .7), size = .3, color = "#F0F0F0") + 
  geom_segment(aes(x = .5, xend = .5, y = .3, yend = .7), size = .3, color = "#F0F0F0") + 
  geom_segment(aes(x = .3, xend = .7, y = .5, yend = .5), size = .3, color = "#F0F0F0") + 
  geom_point(aes(color = party, size = 2, alpha = party_strength), 
             show.legend = FALSE, na.rm = TRUE) + 
  geom_label_repel(aes(label = state_abb),
                   size = 3,
                   segment.colour = NA, 
                   label.size = NA, 
                   na.rm = TRUE,
                   fill = alpha("white", 0)) + 
  scale_color_manual(values = party_colors) + 
  scale_x_continuous(labels = NULL, limits = c(.3, .70)) + 
  scale_y_continuous(labels = scales::label_percent(accuracy = 1), limits = c(.3, .70)) + 
  labs(
    x = glue::glue(
    "&#x2190; More votes for ",
    "<strong style = 'color:{party_colors['Blue']}'>Biden</strong>",
    "<span style = 'color:white'>_____________________</span>",
    "More votes for <strong style = 'color:{party_colors['Red']}'>Trump</strong> &#x2192;"),
    y = element_blank(),
    caption = glue::glue(
      "Code: github.com/tgerke/vax_and_votes<br>",
      "Twitter: @travisgerke"
    )) + 
  theme(
    panel.grid.major = element_blank(), 
    axis.title.x = element_markdown(margin = margin(-15, 0, 0, 0)),
    axis.text.y = element_text(hjust = 5),
    plot.margin = margin(0, .3, 0, 0, "cm")
  )
